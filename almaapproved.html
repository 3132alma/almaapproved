<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alma Approved Barcode Nutrition Lookup</title>
  <!-- QuaggaJS for barcode decoding -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    :root {
      --primary-color: #00b894;
      --accent-color: #ff7675;
      --bg-color: #fdfdfd;
      --card-bg: #ffffff;
      --text-color: #333;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; padding: 1rem; }
    .container { width: 100%; max-width: 480px; background-color: var(--card-bg); border: 2px solid var(--accent-color); border-radius: 12px; padding: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; }
    .approved-heading { font-size: 1.5rem; font-family: 'Brush Script MT', cursive; color: var(--accent-color); margin-bottom: 0.5rem; }
    .sub-heading { font-size: 1.1rem; color: var(--primary-color); margin-bottom: 1rem; }
    #file-input { width: 100%; padding: 0.75rem; background-color: var(--accent-color); color: #fff; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; margin-bottom: 1rem; }
    #file-input:hover { background-color: #ff5252; }
    #result { margin-top: 1rem; }
    .product-card { background: var(--bg-color); border: 1px solid var(--accent-color); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; text-align: left; }
    .product-card img { width: 100%; height: auto; border-radius: 8px; display: block; margin-bottom: 0.75rem; }
    .product-details h3 { font-size: 1rem; color: var(--text-color); margin-bottom: 0.5rem; }
    .nutriscore { margin-top: 0.75rem; text-align: center; }
    .nutriscore img { width: 60px; margin-bottom: 0.25rem; }
    .nutriscore p { font-size: 0.9rem; margin: 0.25rem 0; color: var(--primary-color); font-weight: bold; }
    .nutrition-facts { margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 0.75rem; font-size: 0.9rem; color: var(--text-color); }
    .nutrition-facts h4 { margin-bottom: 0.5rem; font-size: 1rem; color: var(--primary-color); }
    .nutrition-facts ul { list-style: none; }
    .nutrition-facts li { margin-bottom: 0.25rem; }
    @media (max-width: 600px) {
      .approved-heading { font-size: 1.3rem; }
      .sub-heading { font-size: 1rem; }
      #file-input { font-size: 0.95rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="approved-heading">Alma Approved</h1>
    <div class="sub-heading">üì∑ Barcode & Nutrition</div>
    <input type="file" id="file-input" accept="image/*" />
    <div id="result"></div>
  </div>
  <script>
    function getLetterGrade(score) {
      if (score >= 80) return 'A';
      if (score >= 60) return 'B';
      if (score >= 40) return 'C';
      if (score >= 20) return 'D';
      return 'E';
    }

    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = function() {
        Quagga.decodeSingle({ src: reader.result, numOfWorkers: 0, decoder: { readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'] } }, function(result) {
          const resultDiv = document.getElementById('result'); resultDiv.innerHTML = '';
          const headingEl = document.querySelector('.approved-heading'); headingEl.textContent = 'Alma Approved';
          if (result && result.codeResult) {
            const code = result.codeResult.code;
            fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`).then(res => res.json()).then(data => {
              if (data.status !== 1) { resultDiv.innerHTML = '<p>‚ùå Product not found.</p>'; return; }
              const prod = data.product; const name = prod.product_name || 'Unknown product'; const imgUrl = prod.image_url || '';
              const n = prod.nutriments || {};
              let score = parseFloat(prod.nutriscore_score);
              if (isNaN(score)) {
                const sugar=n['sugars_100g']||0, fat=n['saturated-fat_100g']||0, salt=n['salt_100g']||0, fib=n['fiber_100g']||0;
                const raw = fib*2 - (sugar*5 + fat*6 + salt*7);
                score = Math.round(Math.max(0,Math.min(100,50+raw)));
              }
              const letter = getLetterGrade(score);
              headingEl.textContent = score>=80 ? 'Alma approved! üëç' : "Alma doesn't approve! üëé";
              const nsImg = `https://static.openfoodfacts.org/images/misc/nutriscore-${letter.toLowerCase()}.svg`;

              let html = `<div class="product-card">`;
              if(imgUrl) html+=`<img src="${imgUrl}" alt="${name}">`;
              html+=`<div class="product-details"><h3>${name}</h3><p><strong>Barcode:</strong> ${code}</p></div>`;
              html+=`<div class="nutriscore"><img src="${nsImg}" alt="${letter}"><p>Score: ${score}/100</p><p>A-E: ${letter}</p></div>`;
              // Nutrition facts list
              html+=`<div class="nutrition-facts"><h4>Nutrition per 100g</h4><ul>`;
              const facts = {
                'Energy (kcal)': n['energy-kcal_100g'],
                'Fat (g)': n['fat_100g'],
                'Saturated Fat (g)': n['saturated-fat_100g'],
                'Carbohydrates (g)': n['carbohydrates_100g'],
                'Sugars (g)': n['sugars_100g'],
                'Fiber (g)': n['fiber_100g'],
                'Protein (g)': n['proteins_100g'],
                'Salt (g)': n['salt_100g']
              };
              for(let key in facts){
                let val = facts[key];
                if(val!==undefined) html+=`<li><strong>${key}:</strong> ${parseFloat(val).toFixed(1)}</li>`;
              }
              html+=`</ul></div></div>`;
              resultDiv.innerHTML = html;
            }).catch(err=>resultDiv.innerHTML=`<p>‚ùå Error: ${err}</p>`);
          } else {
            resultDiv.innerHTML = '<p>‚ö†Ô∏è No barcode detected.</p>'; }
        });
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
